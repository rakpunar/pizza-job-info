<html>
    <title>Status Tracker</title>
    <div id="container" style="width: 300px; position: fixed; right: 20px; top: 20px; font-family: Arial; color: white;">
        <div id="dragHeader" style="background: rgba(30,30,30,0.95); padding: 8px; border-radius: 5px 5px 0 0; cursor: move;">
            <span style="font-size: 12px; color: #999;">DURUM TAKİP</span>
        </div>

        <div id="content" style="background: rgba(30,30,30,0.95); padding: 10px; border-radius: 0 0 5px 5px;">
            <div id="error" style="color: #ff4444; margin-bottom: 10px; display: none;">Veri alınamadı!</div>
            
            <div style="margin-bottom: 15px;">
                <div style="color: #999; font-size: 12px;">AKTİF GÖREV</div>
                <div style="font-size: 16px; margin-top: 3px;" id="activeTask">-</div>
            </div>

            <div>
                <div style="color: #999; font-size: 12px;">ENVANTER</div>
                <div id="inventory" style="font-size: 14px; margin-top: 3px;">Yükleniyor...</div>
            </div>
        </div>
    </div>

    <script>
        const dragElement = (elmnt) => {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            elmnt.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                
                const newTop = elmnt.parentElement.offsetTop - pos2;
                const newLeft = elmnt.parentElement.offsetLeft - pos1;
                
                elmnt.parentElement.style.top = Math.max(0, Math.min(window.innerHeight - elmnt.parentElement.offsetHeight, newTop)) + "px";
                elmnt.parentElement.style.left = Math.max(0, Math.min(window.innerWidth - elmnt.parentElement.offsetWidth, newLeft)) + "px";
                elmnt.parentElement.style.right = 'auto';
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        dragElement(document.getElementById("dragHeader"));

        let lastUpdate = 0;
        const updateInterval = 1000;

        const showError = () => {
            document.getElementById('error').style.display = 'block';
            document.getElementById('activeTask').textContent = '-';
            document.getElementById('inventory').innerHTML = '-';
        };

        window.addEventListener("message", (event) => {
            const evt = event.data;
            if (!evt.data) {
                showError();
                return;
            }

            document.getElementById('error').style.display = 'none';
            lastUpdate = Date.now();

            if (evt.data.job || evt.data.menu) {
                const job = evt.data.job || '';
                const menu = evt.data.menu || '';
                const menuChoice = evt.data.menu_choice || '';
                document.getElementById('activeTask').textContent = `${job} ${menu} ${menuChoice}`.trim();
            }

            if (evt.data.inventory) {
                try {
                    const inv = typeof evt.data.inventory === 'string' ? 
                        JSON.parse(evt.data.inventory) : evt.data.inventory;

                    const invHtml = Object.entries(inv)
                        .map(([item, count]) => `<div style="display: flex; justify-content: space-between; padding: 2px 0;">
                            <span>${item}:</span>
                            <span>${count}</span>
                        </div>`)
                        .join('');

                    document.getElementById('inventory').innerHTML = invHtml || 'Envanter boş';
                } catch (e) {
                    console.error('Envanter parse hatası:', e);
                    document.getElementById('inventory').innerHTML = 'Envanter hatası';
                }
            }
        });

        window.parent.postMessage({type: "getData"}, "*");

        setInterval(() => {
            if (Date.now() - lastUpdate > updateInterval * 2) {
                showError();
            }
            window.parent.postMessage({type: "getData"}, "*");
        }, updateInterval);

        window.addEventListener('keydown', (e) => {
            if (e.key === "Escape") {
                window.parent.postMessage({type: "pin"}, "*");
            }
        });
    </script>
</html>
